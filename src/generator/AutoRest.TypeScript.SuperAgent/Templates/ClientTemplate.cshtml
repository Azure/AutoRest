@using System.Linq
@using AutoRest.Core.Utilities
@using AutoRest.TypeScript.SuperAgent.Model
@inherits AutoRest.Core.Template<AutoRest.TypeScript.SuperAgent.CodeModelTs>

// API version: @Model.ApiVersion
// Generated by: @Model.GeneratedBy at @Model.GeneratedAt
// Tool version: @Model.GeneratorVersion

import { Promise } from 'es6-promise';
import * as request from 'superagent';

class Url{
    protected url: string;

    public constructor(baseUrl: string){
        this.url = baseUrl;
    }

    public Url addToPath(name: string, value: string){
        this.url.replace('{'  + name +  '}', value);
        return this;
    }

    public Url addToQuery(name: string, value: string){
        this.url.replace('{'  + name +  '}', value);
        return this;
    }

    public Url add(url: string){
        this.url += url;
        return this;
    }

    public toString() : string {
        return this.url;
    }
}

type CreateReq = (url : string) => Req;
type ReqHandler = (req : CreateReq) => Req;

class ApiClient<T> {

	private req : Req;
	private url : Url;

    construtor(req : Req, url: Url){
		req.set('Accept', 'application/json');
		this.req = req;
		this.url = url;
    }
    
    public async withReq(handler: ReqHandler) : Promise<T>{
        return new Promise<T>((resolve, reject) => {
        try{
			handler(this.req, this.url).end((err, res) => err === undefined ? resolve(res.body as T) : reject(err));
		}
		catch (e)
		{
			reject(e);
		}
	}
}

abstract class BaseApi {
    readonly baseUrl: string

    protected constructor(baseUrl: string){
        if(baseUrl === undefined || baseUrl === null){
            baseUrl = "";
        }
        this.baseUrl = baseUrl;
    }

    protected newUrl(url : string){
        return new Url(this.baseUrl).add(url);
    }
}

@foreach (var group in Model.MethodGroups)
{
    var apiName = $"{group.Key.ToPascalCase().Replace("Api", "")}Api";
    var apiInterfaceName = $"I{apiName}";
@:export interface @(apiInterfaceName) {
    foreach (var tsMethod in group.Select(m => new MethodModelTs(group.Key, m)))
    {
@:    @(tsMethod.MethodName)(requestDto: @(tsMethod.RequestTypeName)) : @(tsMethod.ResponsePromiseTypeName);
    }
@:}

@:export class @(apiName) extends BaseApi implements @(apiInterfaceName) {
@:
@:    public constructor(baseUrl: string) {
@:        super(baseUrl);
@:    }
    foreach (var method in group)
    {
        var tsMethod = new MethodModelTs(group.Key, method);
        var tsParams = new ParametersModelTs(method.Parameters);

@:    public async @(tsMethod.MethodName)(requestDto: @(tsMethod.RequestTypeName)) : @(tsMethod.ResponsePromiseTypeName) {
@:        return await new ApiClient<@(tsMethod.ResponseTypeName)>(
@:            url => request.@(method.HttpMethod.ToString().ToLower())(url), 
@:            this.newUrl('@(method.Url)'))
@:                .withReq((reqFactory, url) => {
@:                    requestDto.validate();

        foreach (var name in tsParams.ParamNamesInPath) {
@:                    url.addToPath('@(name)', requestDto.@(name));
        }

        foreach (var name in tsParams.ParamNamesInQuery)
        {
@:                    url.addToQuery('@(name)', requestDto.@(name));
        }
@:                    return reqFactory(url.toString())
        foreach (var name in tsParams.ParamNamesInBody)
        {
@:                        .send(requestDto.@(name))
        }

        foreach (var name in tsParams.ParamNamesInHeader)
        {
@:                        .set('@(name)', requestDto.@(name))
        };
@:            });
@:    }
    }
}
}


